# ansible_ec2_setup/tasks/setup_certbot.yml

- name: Certbot & Apache plugin install
  yum:
    name: certbot-apache
    state: present

- name: Obtain/renew Letâ€™s Encrypt cert
  command: >-
    certbot --apache -n --agree-tos
            -m admin@{{ domain_name }}
            -d {{ domain_name }}
            --redirect
  args:
    creates: /etc/letsencrypt/live/{{ domain_name }}/fullchain.pem
  notify: reload httpd

- name: Ensure /etc/cron.d exists
  file:
    path: /etc/cron.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Add certbot auto-renew cron job
  copy:
    dest: /etc/cron.d/certbot-renew
    content: |
      0 3 * * * root certbot renew --quiet
    owner: root
    group: root
    mode: '0644'

